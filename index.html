<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>選挙集図盤</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/search.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css"
      integrity="sha384-p5cy4wHtKSqjnLUNjQ+8ffCwUp0vlLS+6lg1lc3qqXax2E1EmVCMCAimU+R0MOZH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <header>
      <h1>選挙集図盤</h1>
      <p>
        直近4年分の最新選挙結果をもとに、議席の分布や候補者動向を可視化します。政党別の勢力推移と、全国の候補者情報を検索できるツールです。
      </p>
    </header>
    <main>
            <nav class="dashboard-nav" aria-label="ページ切替">
        <button
          type="button"
          class="dashboard-tab is-active"
          id="tab-party"
          data-view="party-dashboard"
          aria-controls="party-dashboard"
          aria-selected="true"
        >
          党派の傾向分析
        </button>
        <button
          type="button"
          class="dashboard-tab"
          id="tab-compensation"
          data-view="compensation-dashboard"
          aria-controls="compensation-dashboard"
          aria-selected="false"
        >
          議員報酬
        </button>
        <button
          type="button"
          class="dashboard-tab"
          id="tab-choropleth"
          data-view="choropleth-dashboard"
          aria-controls="choropleth-dashboard"
          aria-selected="false"
        >
          党勢地図
        </button>
        <button
          type="button"
          class="dashboard-tab"
          id="tab-win-rate"
          data-view="win-rate-dashboard"
          aria-controls="win-rate-dashboard"
          aria-selected="false"
        >
          当選割合
        </button>
        <button
          type="button"
          class="dashboard-tab"
          id="tab-optimization"
          data-view="optimization-dashboard"
          aria-controls="optimization-dashboard"
          aria-selected="false"
        >
          得票の最適化
        </button>
        <button
          type="button"
          class="dashboard-tab"
          id="tab-search"
          data-view="search-dashboard"
          aria-controls="search-dashboard"
          aria-selected="false"
        >
          選挙結果検索
        </button>
      </nav>

      <section
        id="party-dashboard"
        class="dashboard-view is-active"
        role="region"
        aria-labelledby="tab-party"
      >
        <section class="summary-grid">
          <article class="summary-item">
            <span>対象自治体</span>
            <strong id="summary-municipalities">-</strong>
            <small>直近4年分の最新選挙を集計</small>
          </article>
          <article class="summary-item">
            <span>集計議席数</span>
            <strong id="summary-seats">-</strong>
            <small>各自治体の最新選挙の総議席数</small>
          </article>
          <article class="summary-item">
            <span>掲載政党数</span>
            <strong id="summary-parties">-</strong>
            <small>掲載されている政党・会派の数</small>
          </article>
        </section>

        <section class="card">
          <h2>政党別所属議員数</h2>
          <p class="description">
            最新選挙で当選した議員を政党・会派ごとに集計した座席数を表示しています（上位会派のみ表示）。
          </p>
          <div class="party-metric-grid" id="party-metric-grid" aria-live="polite"></div>
        </section>

        <section class="card">
          <h2>政党別所属議員数の推移</h2>
          <p class="description">
            各自治体の最新選挙日を時系列に並べ、累積議席数の推移を描画しています。折れ線は政党ごとの勢力の伸び縮みを示します（上位会派のみ表示）。
          </p>
          <div id="party-trend-chart" class="chart" aria-label="政党別所属議員数の推移"></div>
        </section>
      </section>

      <section
        id="compensation-dashboard"
        class="dashboard-view"
        role="region"
        aria-labelledby="tab-compensation"
      >
        <section class="card">
          <h2>政党別議員報酬推計</h2>
          <p class="description" id="compensation-description">
            2020年時点の議員報酬月額と期末手当支給率を基準に、選挙実施月から次回選挙（または任期満了）までの在任月数と支給月を按分した推計です。
          </p>
          <form class="compensation-controls" aria-label="集計期間の設定">
            <label for="compensation-year-span">
              集計に含める最新の年数
              <small>（初期値：当年の1年分）</small>
            </label>
            <div class="control-group">
              <input
                type="number"
                id="compensation-year-span"
                name="compensation-year-span"
                min="0"
                max="50"
                step="1"
                value="1"
                inputmode="numeric"
              />
              <button type="button" id="compensation-apply-span" class="button is-small">
                反映
              </button>
            </div>
            <p class="help-text" id="compensation-span-help">
              0 を指定すると全期間を対象にします。
            </p>
          </form>
          <div class="summary-grid"><div class="summary-grid"><div class="summary-grid"><div class="summary-grid">
            <article class="summary-item">
              <span>推計総額</span>
              <strong id="comp-summary-total">-</strong>
              <small id="comp-summary-note"></small>
            </article>
            <article class="summary-item">
              <span>座席数</span>
              <strong id="comp-summary-seats">-</strong>
              <small>推計対象となった議員数</small>
            </article>
            <article class="summary-item">
              <span>自治体数</span>
              <strong id="comp-summary-municipalities">-</strong>
              <small>突合できた自治体数</small>
            </article>
          </div>
        </section>

        <section class="card">
          <h3>政党別推計年額</h3>
          <div
            id="compensation-bar-chart"
            class="chart compensation-chart"
            aria-label="政党別推計年額（上位10党）"
          ></div>
        </section>

        <section class="card">
          <h3>年別推移</h3>
          <div
            id="compensation-trend-chart"
            class="chart compensation-chart"
            aria-label="年別推移（推計上位党）"
          ></div>
        </section>

        <section class="card">
          <h3>政党別推計年額ランキング</h3>
          <p class="description">
            推計年額は、自治体別に算出した年額（議員報酬月額×(12 + 期末手当率の合計/100)）に当選議員数を掛けて集計しています。
          </p>
          <div class="compensation-table-wrapper">
            <table class="search-table">
              <thead>
                <tr>
                  <th scope="col">順位</th>
                  <th scope="col">政党</th>
                  <th scope="col">座席数</th>
                  <th scope="col">自治体数</th>
                  <th scope="col">推計年額</th>
                </tr>
              </thead>
              <tbody id="compensation-table-body"></tbody>
            </table>
          </div>
          <p id="compensation-error" class="compensation-error" hidden></p>
        </section>
      </section>

      <section
        id="choropleth-dashboard"
        class="dashboard-view"
        role="region"
        aria-labelledby="tab-choropleth"
      >
        <section class="card choropleth-card">
          <h2>党勢地図</h2>
          <p class="description">
            年・議会区分・党派を選ぶと、全国47都道府県での議席占有率や議員数を切り替えて表示します。
          </p>
          <fieldset class="choropleth-metric-tabs" role="tablist" aria-label="表示指標">
            <legend class="sr-only">表示指標</legend>
            <div class="choropleth-metric-option">
              <input
                type="radio"
                name="choropleth-metric"
                id="choropleth-metric-ratio"
                value="ratio"
                data-choropleth-metric="ratio"
                checked
              />
              <label
                for="choropleth-metric-ratio"
                class="choropleth-metric-tab"
                role="tab"
                data-choropleth-metric="ratio"
                aria-controls="choropleth-map"
              >
                議席占有率
              </label>
            </div>
            <div class="choropleth-metric-option">
              <input
                type="radio"
                name="choropleth-metric"
                id="choropleth-metric-seats"
                value="seats"
                data-choropleth-metric="seats"
              />
              <label
                for="choropleth-metric-seats"
                class="choropleth-metric-tab"
                role="tab"
                data-choropleth-metric="seats"
                aria-controls="choropleth-map"
              >
                議員数
              </label>
            </div>
          </fieldset>
          <form class="choropleth-controls" aria-label="表示条件の選択">
            <fieldset class="choropleth-control-group">
              <legend class="choropleth-control-heading">議会区分</legend>
              <div
                id="choropleth-scope"
                class="choropleth-scope-options"
                role="radiogroup"
                aria-label="議会区分"
              ></div>
            </fieldset>
            <fieldset class="choropleth-control-group">
              <legend class="choropleth-control-heading">年</legend>
              <div class="choropleth-control choropleth-year-control">
                <input
                  type="range"
                  id="choropleth-year"
                  class="choropleth-year-slider"
                  min="0"
                  max="0"
                  step="1"
                  value="0"
                  aria-label="表示年"
                />
                <span id="choropleth-year-display" class="choropleth-year-display">-</span>
              </div>
            </fieldset>
            <fieldset class="choropleth-control-group">
              <legend class="choropleth-control-heading">党派</legend>
              <div class="choropleth-control choropleth-party-control">
                <select id="choropleth-party"></select>
              </div>
            </fieldset>
          </form>
          <div class="choropleth-map-wrapper">
            <div
              id="choropleth-map"
              class="choropleth-map"
              role="img"
              aria-label="都道府県別議席率"
            ></div>
            <div id="choropleth-legend" class="choropleth-legend" aria-live="polite"></div>
            <div id="choropleth-info" class="choropleth-info" hidden></div>
          </div>
          <p id="choropleth-summary" class="choropleth-summary"></p>
        </section>
      </section>

      <section
        id="win-rate-dashboard"
        class="dashboard-view"
        role="region"
        aria-labelledby="tab-win-rate"
      >
        <section class="card">
          <h2>全期間の当選割合</h2>
          <p class="description">
            直近4年分の最新選挙データから、各政党の立候補者数と当選者数を集計して当選割合を算出しています。
          </p>
          <div id="win-rate-summary" class="win-rate-summary" aria-live="polite"></div>
        </section>
        <section class="card">
          <h2>政党別当選割合の推移</h2>
          <p class="description">
            日ごとの当選割合を散布図で表示し、任意の日数で集計した期間平均を折れ線で重ねています。期間設定を変えることで政党の勢いを把握しやすくなります。
          </p>
          <form class="win-rate-controls" id="win-rate-average-form">
            <label for="win-rate-average-days">集計期間（日）</label>
            <div class="control-group">
              <input
                type="number"
                id="win-rate-average-days"
                name="win-rate-average-days"
                min="1"
                max="365"
                step="1"
                inputmode="numeric"
              />
              <button type="submit">反映</button>
              <button type="button" id="win-rate-clear-series" class="button-secondary">全政党を非表示</button>
            </div>
          </form>
          <div
            id="win-rate-chart"
            class="chart"
            aria-label="政党別当選割合の推移"
          ></div>
        </section>
      </section>


      <section
        id="optimization-dashboard"
        class="dashboard-view"
        role="region"
        aria-labelledby="tab-optimization"
      >
        <section class="card">
          <h2>得票の最適化</h2>
          <p class="description">
            当選者の得票が揃っている選挙だけを対象に、党派別の得票総数を最低当選得票で割り、理論上の最大当選数を算出しました。
            現在の当選数との差分を見ることで、得票配分の余地を把握できます。
          </p>
          <div class="summary-grid">
            <article class="summary-item">
              <span>分析対象選挙</span>
              <strong id="optimization-summary-elections">-</strong>
              <small>欠損のない選挙のみ</small>
            </article>
            <article class="summary-item">
              <span>除外された選挙</span>
              <strong id="optimization-summary-excluded">-</strong>
              <small>勝者の得票が欠ける場合など</small>
            </article>
            <article class="summary-item">
              <span>分析期間</span>
              <strong id="optimization-summary-period">-</strong>
              <small>直近4年相当</small>
            </article>
          </div>
          <p id="optimization-exclusion-note" class="help-text"></p>
        </section>

        <section class="card">
          <h2>党別サマリーボード</h2>
          <p class="description">
            過去4年間に集計できた選挙で、各党が理論上確保できる最大議席数をテキストでまとめました（上位10党）。
          </p>
          <div id="optimization-summary-board" class="summary-board" aria-live="polite"></div>
        </section>

        <section class="card">
          <h2>選挙別ギャップ分析</h2>
          <p class="description">
            選挙ごとに理論最大と実際の当選数を比較できます。上位のグラフで党別の差分を確認し、下部の検索で個別選挙を探してください。
          </p>
          <div class="optimization-analysis-grid">
            <div id="optimization-election-chart" class="chart optimization-chart" aria-label="党別理論最大と実際の当選数"></div>
            <div class="search-table-wrapper optimization-detail-table">
              <p id="optimization-min-vote-note" class="optimization-note"></p>
              <table class="search-table">
                <thead>
                  <tr>
                    <th scope="col">党派</th>
                    <th scope="col">実数</th>
                    <th scope="col">総得票数</th>
                    <th scope="col">総得票数 / 最低得票</th>
                    <th scope="col">理論最大</th>
                  </tr>
                </thead>
                <tbody id="optimization-election-detail"></tbody>
              </table>
            </div>
          </div>
          <div class="optimization-search-panel" aria-label="ギャップ検索">
            <form
              id="optimization-search-form"
              class="optimization-search-form"
              aria-label="選挙検索"
              novalidate
            >
              <div class="optimization-search-group">
                <label for="optimization-search-keyword">選挙名</label>
                <input
                  type="text"
                  id="optimization-search-keyword"
                  name="keyword"
                  placeholder="例：○○市議会議員選挙"
                />
              </div>
              <div class="optimization-search-group">
                <label for="optimization-search-min-gap">最小ギャップ</label>
                <input
                  type="number"
                  id="optimization-search-min-gap"
                  name="minGap"
                  min="0"
                  step="1"
                  inputmode="numeric"
                />
              </div>
              <div class="optimization-search-actions">
                <button type="button" id="optimization-search-reset" class="button-secondary">
                  条件をリセット
                </button>
              </div>
            </form>
            <div class="search-table-wrapper">
              <table class="search-table">
                <thead>
                  <tr>
                    <th scope="col">選挙名</th>
                    <th scope="col">日付</th>
                    <th scope="col">当選者数</th>
                    <th scope="col">最低当選得票</th>
                    <th scope="col">ギャップ</th>
                  </tr>
                </thead>
                <tbody id="optimization-search-results"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card">
          <h2>政党別の潜在議席</h2>
          <p class="description">
            各党の合計得票を最低当選ラインで割った理論最大当選数と、実際の当選数・ギャップを比較します。
          </p>
          <div class="search-table-wrapper">
            <table class="search-table">
              <thead>
                <tr>
                  <th scope="col">政党</th>
                  <th scope="col">合計得票</th>
                  <th scope="col">理論最大当選</th>
                  <th scope="col">実際の当選</th>
                  <th scope="col">ギャップ</th>
                  <th scope="col">達成率</th>
                  <th scope="col">対象選挙数</th>
                </tr>
              </thead>
              <tbody id="optimization-party-table-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <h2>ギャップが大きい選挙</h2>
          <p class="description">
            理論上の当選数と実際の当選数の差が大きい選挙（上位20件）を表示します。得票配分の改善余地が大きい自治体です。
          </p>
          <div class="search-table-wrapper">
            <table class="search-table">
              <thead>
                <tr>
                  <th scope="col">選挙</th>
                  <th scope="col">最低当選得票</th>
                  <th scope="col">合計得票</th>
                  <th scope="col">当選者数</th>
                  <th scope="col">ギャップ合計</th>
                  <th scope="col">最大ギャップ党</th>
                </tr>
              </thead>
              <tbody id="optimization-election-table-body"></tbody>
            </table>
          </div>
        </section>
      </section>


      <section
        id="search-dashboard"
        class="dashboard-view"
        role="region"
        aria-labelledby="tab-search"
      >
        <section class="search-intro card">
          <h2>選挙結果検索</h2>
          <p class="search-description">
            データセット全体から候補者情報を検索できます。選挙名や日付で絞り込み、候補者の属性や得票状況を確認してください。
          </p>
          <div class="search-summary-grid">
            <article class="search-summary-item">
              <span>掲載選挙数</span>
              <strong id="search-summary-elections">-</strong>
            </article>
            <article class="search-summary-item">
              <span>候補者数</span>
              <strong id="search-summary-candidates">-</strong>
            </article>
            <article class="search-summary-item">
              <span>政党・会派数</span>
              <strong id="search-summary-parties">-</strong>
            </article>
            <article class="search-summary-item">
              <span>平均競争倍率</span>
              <strong id="search-summary-competition">-</strong>
            </article>
          </div>
          <form class="search-filters" id="search-filters" novalidate>
            <div class="search-filter-group">
              <label for="search-text">選挙名で検索</label>
              <input id="search-text" type="search" placeholder="例: 横浜市長選挙" />
            </div>
            <div class="search-filter-group">
              <label for="party-select">政党・会派で絞り込み</label>
              <select id="party-select">
                <option value="">すべて</option>
              </select>
            </div>
            <div class="search-filter-group">
              <label>投票日で絞り込み</label>
              <div class="search-date-range">
                <input id="date-start" type="date" aria-label="開始日" />
                <input id="date-end" type="date" aria-label="終了日" />
              </div>
            </div>
            <div class="search-filter-actions">
              <button id="reset-button" type="button" class="search-reset">
                条件をクリア
              </button>
            </div>
          </form>
        </section>

        <section class="search-layout">
          <article class="search-card">
            <h3>年別の選挙件数</h3>
            <div id="timeline-chart" class="search-chart" aria-label="年別の選挙件数"></div>
          </article>
          <article class="search-card">
            <h3>政党別の出馬状況</h3>
            <div id="party-chart" class="search-chart" aria-label="政党別の出馬状況"></div>
          </article>
          <article class="search-card">
            <h3>候補者属性の構成</h3>
            <div
              id="demographics-chart"
              class="search-chart"
              aria-label="候補者属性の構成"
            ></div>
          </article>
        </section>

        <section class="search-card">
          <div class="search-results-header">
            <h3>検索結果</h3>
            <p id="results-count" class="search-results-count">0 件表示中</p>
          </div>
          <div class="search-table-wrapper">
            <table class="search-table">
              <thead>
                <tr>
                  <th scope="col">選挙名</th>
                  <th scope="col">投票日</th>
                  <th scope="col">定数</th>
                  <th scope="col">候補者数</th>
                  <th scope="col">政党・会派</th>
                  <th scope="col">結果</th>
                </tr>
              </thead>
              <tbody id="results-body"></tbody>
            </table>
          </div>
        </section>
      </section>
    </main>
    <footer id="data-range-note"></footer>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script
      src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"
      integrity="sha384-vpn/ucn7785xAq02KoJV78mMCB+FXl+yfBWS2MRjZkzEEvUEsJU3ZarsOD9MSGxu"
      crossorigin="anonymous"
    ></script>
    <script type="module" src="assets/js/main.js"></script>
  </body>
</html>



