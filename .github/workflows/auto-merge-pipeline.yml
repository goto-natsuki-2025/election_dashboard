name: auto-merge-pipeline

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: startsWith(github.event.pull_request.head.ref, 'pipeline/')
    runs-on: ubuntu-latest
    steps:
      - name: Check mergeability
        uses: actions/github-script@v7
        id: check
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) { core.setFailed('No pull_request payload'); return; }
            const { data } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            if (data.mergeable === false) {
              core.setFailed('PR is not mergeable (conflicts or blocked)');
              return;
            }
            core.setOutput('pr_number', pr.number);

      - name: Merge PR (squash)
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.check.outputs.pr_number }}
        with:
          github-token: ${{ secrets.MERGE_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER || 0);
            if (!prNumber) { core.setFailed('PR number missing'); return; }
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });
